# Warehouse Management Service

Сервис для мониторинга состояния склада. Позволяет отслеживать перемещения товаров между складами и текущее количество товаров на складах.

## Структура проекта

```
.
├── app                  # Основной код приложения
│   ├── api              # API эндпоинты
│   ├── cache            # Кэширование
│   ├── config           # Конфигурация
│   ├── db               # Работа с базой данных
│   ├── models           # Модели данных
│   └── services         # Бизнес-логика
├── tests                # Тесты
│   ├── api              # Тесты API
│   ├── db               # Тесты базы данных
│   ├── models           # Тесты моделей
│   └── services         # Тесты сервисов
├── main.py              # Точка входа в приложение
├── pyproject.toml       # Зависимости и конфигурация Poetry
└── README.md            # Этот файл
```

## Технологии

- **Python 3.12**: Основной язык программирования
- **FastAPI**: Web-фреймворк для создания API
- **SQLAlchemy**: ORM для работы с базой данных
- **PostgreSQL**: Реляционная база данных
- **Kafka**: Очередь сообщений для асинхронной обработки
- **Redis**: Кэширование данных
- **Prometheus**: Мониторинг
- **Pytest**: Тестирование

## Функциональность

### API

1. **GET /api/warehouses/{warehouse_id}/products/{product_id}**
   - Получение текущего количества товара на складе
   - Включает историю движения товара
   - Кэширование результатов

2. **GET /api/movements/{movement_id}**
   - Получение детальной информации о перемещении
   - Включает информацию о времени в пути
   - Кэширование результатов

### Обработка Kafka

- Асинхронная обработка сообщений о движении товаров
- Поддержка событий `departure` и `arrival`
- Автоматическое обновление количества товаров на складах
- Связывание событий отправки и прибытия
- Использование ThreadPool для параллельной обработки партиций

### Кэширование

- Кэширование результатов API запросов в Redis
- Настраиваемое время жизни кэша
- Автоматическая инвалидация кэша при изменении данных

### Мониторинг

- Prometheus метрики для отслеживания производительности
- Метрики запросов API (количество, время выполнения)
- Метрики обработки Kafka (количество обработанных сообщений, ошибки)
- Метрики состояния системы (активные перемещения)

### Тестирование

- Юнит-тесты для всех компонентов
- Интеграционные тесты API
- Тесты сервисов с мок-данными
- Автоматическое создание тестовой базы данных

## Установка и запуск

### Требования

- Python 3.12+
- Poetry
- PostgreSQL
- Kafka
- Redis

### Установка зависимостей

```bash
poetry install
```

### Запуск

```bash
poetry run python main.py
```

### Запуск тестов

```bash
poetry run pytest
```

## Улучшения и расширения

1. **Кэширование**: Реализовано кэширование API запросов с использованием Redis
2. **Мониторинг**: Добавлены Prometheus метрики для отслеживания производительности и состояния системы
3. **Тестирование**: Расширены тесты для покрытия всех компонентов системы

## Настройка

Конфигурация сервиса осуществляется через переменные окружения или файл `.env`:

```
# Server settings
HOST=0.0.0.0
PORT=8000
DEBUG=true

# Database settings
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=warehouse_db
POSTGRES_HOST=postgres
POSTGRES_PORT=5432

# Kafka settings
KAFKA_BOOTSTRAP_SERVERS=kafka:9092
KAFKA_TOPIC=warehouse_movements
KAFKA_GROUP_ID=warehouse_service

# Redis settings
REDIS_HOST=redis
REDIS_PORT=6379

# Metrics settings
METRICS_PORT=9090

# Cache settings
CACHE_TTL=60
```

## Требования

- Обязательное использование языка Python и фреймворка FastAPI для разработки микросервиса. Обязательное использование Kafka как брокера сообщений.
- Кандидат имеет свободу выбора технологий и библиотек(кроме указанных выше) для реализации остальных аспектов задачи.

## Сдача
Склонируйте проект, выполните задачу и пришлите ссылку на репозиторий.

## Задание
Вам предстоит разработать микросервис на языке Python, предназначенный для обработки сообщений от складов, которые уведомляют о приемках и отправках товаров. 
Микросервис будет сохранять данные о перемещениях и предоставлять API для получения информации о конкретных перемещениях и текущих состояниях складов.

### Основные задачи

1. Обрабатывать сообщения, поступающие из очереди Kafka. Сообщения содержат информацию о приемке или отправке товаров на складах.
2. Сохранять информацию о каждом перемещении товара, включая отправителя, получателя, время, количество товаров, тип перемещения.
3. Учитывать, что количество товаров на складе не может быть меньше 0.
4. Предоставить информацию о текущем количестве товаров на складе.
5. Предоставить информацию о  перемещении товара, включая отправителя, получателя, время, прошедшее между отправкой и приемкой, а также разницу в количестве товара, если таковая имеется.
6. Предоставить OpenAPI спецификацию к API

### Примеры сообщений в Kafka
###### Прибытие
```json
{
    "id": "b3b53031-e83a-4654-87f5-b6b6fb09fd99", // id сообщения
    "source": "WH-3423", // источник отправки. формат - WH-****
    "specversion": "1.0",
    "type": "ru.retail.warehouses.movement", 
    "datacontenttype": "application/json",
    "dataschema": "ru.retail.warehouses.movement.v1.0",
    "time": 1737439421623,
    "subject": "WH-3423:ARRIVAL",
    "destination": "ru.retail.warehouses",
    "data": {
        "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0", // id перемещения. Одинаковое для отправки/приемки
        "warehouse_id": "c1d70455-7e14-11e9-812a-70106f431230", // id склада
        "timestamp": "2025-02-18T14:34:56Z", // время приемки
        "event": "arrival", // тип события
        "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55", // id товара
        "quantity": 100 // количество товара
    }
}
```
###### Отбытие
```json
{
    "id": "b3b53031-e83a-4654-87f5-b6b6fb09fd99", 
    "source": "WH-3322",
    "specversion": "1.0",
    "type": "ru.retail.warehouses.movement", 
    "datacontenttype": "application/json",
    "dataschema": "ru.retail.warehouses.movement.v1.0",
    "time": 1737439421623,
    "subject": "WH-3322:DEPARTURE",
    "destination": "ru.retail.warehouses",
    "data": {
        "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0", // id перемещения. Одинаковое для отправки/приемки
        "warehouse_id": "25718666-6af6-4281-b5a6-3016e36fa557", // id склада
        "timestamp": "2025-02-18T12:12:56Z", // время отбытия
        "event": "departure", // тип события
        "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55", // id товара
        "quantity": 100 // количество товара
    }
}
```

### Дополнительные задачи (опционально):

1. Реализовать систему кэширования для повышения скорости ответов на запросы API.
2. Настроить мониторинг сервиса для отслеживания его состояния и производительности.
3. Покрыть кода тестами.
4. Провести нагрузочное тестирование и предоставить график, иллюстрирующий, как приложение ведет себя под разной нагрузкой.


## Спецификация API

### Основные эндпоинты:

#### 1. Получение информации о перемещении

- **URL:** `/api/movements/<movement_id>`
- **Метод:** GET
- **Описание:** Возвращает информацию о перемещении по его ID, включая отправителя, получателя, время, прошедшее между отправкой и приемкой, и разницу в количестве товара.

#### 2. Получение информации о состоянии склада

- **URL:** `/api/warehouses/<warehouse_id>/products/<product_id>`
- **Метод:** GET
- **Описание:** Возвращает информацию текущем запасе товара в конкретном складе.
